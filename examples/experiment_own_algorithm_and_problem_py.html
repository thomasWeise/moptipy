<!doctype html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd"><title></title><meta content="text/html; charset=utf-8"http-equiv=content-type><style>pre{line-height:125%}td.linenos .normal,span.linenos{color:inherit;background-color:#0000;padding-left:5px;padding-right:5px}td.linenos .special,span.linenos.special{color:#000;background-color:#ffffc0;padding-left:5px;padding-right:5px}body .hll{background-color:#ffc}body{background:#f8f8f8}body .c{color:#3d7b7b;font-style:italic}body .err{border:1px solid red}body .k{color:green;font-weight:700}body .o{color:#666}body .ch,body .cm{color:#3d7b7b;font-style:italic}body .cp{color:#9c6500}body .cpf,body .c1,body .cs{color:#3d7b7b;font-style:italic}body .gd{color:#a00000}body .ge{font-style:italic}body .ges{font-style:italic;font-weight:700}body .gr{color:#e40000}body .gh{color:navy;font-weight:700}body .gi{color:#008400}body .go{color:#717171}body .gp{color:navy;font-weight:700}body .gs{font-weight:700}body .gu{color:purple;font-weight:700}body .gt{color:#04d}body .kc,body .kd,body .kn{color:green;font-weight:700}body .kp{color:green}body .kr{color:green;font-weight:700}body .kt{color:#b00040}body .m{color:#666}body .s{color:#ba2121}body .na{color:#687822}body .nb{color:green}body .nc{color:#00f;font-weight:700}body .no{color:#800}body .nd{color:#a2f}body .ni{color:#717171;font-weight:700}body .ne{color:#cb3f38;font-weight:700}body .nf{color:#00f}body .nl{color:#767600}body .nn{color:#00f;font-weight:700}body .nt{color:green;font-weight:700}body .nv{color:#19177c}body .ow{color:#a2f;font-weight:700}body .w{color:#bbb}body .mb,body .mf,body .mh,body .mi,body .mo{color:#666}body .sa,body .sb,body .sc,body .dl{color:#ba2121}body .sd{color:#ba2121;font-style:italic}body .s2{color:#ba2121}body .se{color:#aa5d1f;font-weight:700}body .sh{color:#ba2121}body .si{color:#a45a77;font-weight:700}body .sx{color:green}body .sr{color:#a45a77}body .s1{color:#ba2121}body .ss{color:#19177c}body .bp{color:green}body .fm{color:#00f}body .vc,body .vg,body .vi,body .vm{color:#19177c}body .il{color:#666}</style><body><h2></h2><div class=highlight><pre><span></span><span class=sd>"""</span>
<span class=sd>Perform an experiment with an own algorithm on and problem.</span>

<span class=sd>First, we implement our own optimization problem. We choose the problem</span>
<span class=sd>"Sort the numbers in a list". The solution space of this problem is the</span>
<span class=sd>space of `n` numbers from `0..n-1`. If `n=5`, then the best possible</span>
<span class=sd>solution would be `0,1,2,3,4` and the worst possible solution would be</span>
<span class=sd>`4,3,2,1,0`. A solution `x` should be rated by computing the number of</span>
<span class=sd>"sorting errors" of subsequent numbers, i.e., the number of times that</span>
<span class=sd>`x[i]>x[i+1]`. Thus, the solution `0,1,2,3,4` would have objective value</span>
<span class=sd>`0` and `4,3,2,1,0` would have objective value `4`. Solution `3,2,5,1,0`</span>
<span class=sd>would be rated as `3`.</span>

<span class=sd>We implement this objective function by deriving a new class `MySortProblem`</span>
<span class=sd>from `Objective`. This class receives a member variable `n` for the number of</span>
<span class=sd>elements to sort, the function `evaluate` that counts the number of sorting</span>
<span class=sd>errors in a solution, and the optional functions `lower_bound` and</span>
<span class=sd>`upper_bound`, which provide the upper and lower limit of possible objective</span>
<span class=sd>values. We also override the `__str__` operator to return a short and</span>
<span class=sd>descriptive name of the function as to be used in file names.</span>

<span class=sd>We then implement a rigid optimization algorithm as class `MyAlgorithm` as a</span>
<span class=sd>subclass of `Algorithm`. Here, we only need to override the functions `solve`</span>
<span class=sd>and `__str__`.</span>

<span class=sd>The function `solve` receives an instance of `Process` which provides all the</span>
<span class=sd>information to the search: Its method `create` allows us to create a container</span>
<span class=sd>for the solutions (if we use `Permutations` as solution space, then this will</span>
<span class=sd>be a `numpy.ndarray`). Its method `copy(a, b)` copies the contents of a</span>
<span class=sd>solution `b` to a solution `a`. Its method `should_terminate` becomes `True`</span>
<span class=sd>when the algorithm should stop and terminate. Its method `evaluate(x)`</span>
<span class=sd>computes the objective value of a given solution (via our objective function,</span>
<span class=sd>but it additionally remembers the best-so-far solution). Its function</span>
<span class=sd>`get_random` provides a random number generator that has been initialized with</span>
<span class=sd>an automatically chosen random seed.</span>

<span class=sd>Our `solve` function uses all of this to start by generating a random</span>
<span class=sd>permutation. In each iteration, it draws two random indices and swaps the</span>
<span class=sd>numbers at them. If the result is better, it will be retained. Otherwise, we</span>
<span class=sd>will keep the current solution.</span>

<span class=sd>We also implement the `__str__` function for our optimization algorithm, as it</span>
<span class=sd>provides the name to be used in file names and directory structures.</span>

<span class=sd>With all of these ingredients, we then apply our algorithm to three instances</span>
<span class=sd>of our sorting problem: sort 5 numbers, sort 10 numbers, and sort 100 numbers.</span>
<span class=sd>Via the experiment execution facility, we apply our algorithm for five runs</span>
<span class=sd>to each of these problems. We collect all the results and print them to the</span>
<span class=sd>standard out.</span>
<span class=sd>"""</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pycommons.io.temp</span><span class=w> </span><span class=kn>import</span> <span class=n>temp_dir</span>

<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.api.algorithm</span><span class=w> </span><span class=kn>import</span> <span class=n>Algorithm</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.api.execution</span><span class=w> </span><span class=kn>import</span> <span class=n>Execution</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.api.experiment</span><span class=w> </span><span class=kn>import</span> <span class=n>run_experiment</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.api.objective</span><span class=w> </span><span class=kn>import</span> <span class=n>Objective</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.api.process</span><span class=w> </span><span class=kn>import</span> <span class=n>Process</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.evaluation.end_results</span><span class=w> </span><span class=kn>import</span> <span class=n>from_logs</span>
<span class=kn>from</span><span class=w> </span><span class=nn>moptipy.spaces.permutations</span><span class=w> </span><span class=kn>import</span> <span class=n>Permutations</span>


<span class=k>class</span><span class=w> </span><span class=nc>MySortProblem</span><span class=p>(</span><span class=n>Objective</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""An objective function that rates how well a permutation is sorted."""</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>n</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-></span> <span class=kc>None</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Initialize: Set the number of values to sort.</span>

<span class=sd>        :param n: the scale of the problem</span>
<span class=sd>        """</span>
        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
        <span class=c1>#: the number of numbers to sort</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>n</span> <span class=o>=</span> <span class=n>n</span>

    <span class=k>def</span><span class=w> </span><span class=nf>evaluate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Compute how often a smaller number follows a bigger one.</span>

<span class=sd>        :param x: the permutation</span>
<span class=sd>        """</span>
        <span class=n>errors</span> <span class=o>=</span> <span class=mi>0</span>  <span class=c1># we start at zero errors</span>
        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>):</span>  <span class=c1># for i in 0..n-2</span>
            <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>></span> <span class=n>x</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]:</span>  <span class=c1># that's a sorting error!</span>
                <span class=n>errors</span> <span class=o>+=</span> <span class=mi>1</span>  <span class=c1># so we increase the number</span>
        <span class=k>return</span> <span class=n>errors</span>  <span class=c1># return result</span>

    <span class=k>def</span><span class=w> </span><span class=nf>lower_bound</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Get the lower bound: 0 errors is the optimum.</span>

<span class=sd>        Implementing this function is optional, but it can help in two ways:</span>
<span class=sd>        First, the optimization processes can be stopped automatically when a</span>
<span class=sd>        solution of this quality is reached. Second, the lower bound is also</span>
<span class=sd>        checked when the end results of the optimization process are verified.</span>

<span class=sd>        :returns: 0</span>
<span class=sd>        """</span>
        <span class=k>return</span> <span class=mi>0</span>

    <span class=k>def</span><span class=w> </span><span class=nf>upper_bound</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-></span> <span class=nb>int</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Get the upper bound: `n-1` errors is the most unsorted list.</span>

<span class=sd>        Implementing this function is optional, but it can help, e.g., when</span>
<span class=sd>        the results of the optimization process are automatically checked.</span>

<span class=sd>        :returns: n-1</span>
<span class=sd>        """</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Get the name of this problem.</span>

<span class=sd>        This name is used in the directory structure and file names of the</span>
<span class=sd>        log files.</span>

<span class=sd>        :returns: "sort" + n</span>
<span class=sd>        """</span>
        <span class=k>return</span> <span class=sa>f</span><span class=s2>"sort</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n</span><span class=si>}</span><span class=s2>"</span>


<span class=k>class</span><span class=w> </span><span class=nc>MyAlgorithm</span><span class=p>(</span><span class=n>Algorithm</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""An example for a simple rigidly structured optimization algorithm."""</span>

    <span class=k>def</span><span class=w> </span><span class=nf>solve</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>process</span><span class=p>:</span> <span class=n>Process</span><span class=p>)</span> <span class=o>-></span> <span class=kc>None</span><span class=p>:</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Solve the problem encapsulated in the provided process.</span>

<span class=sd>        :param process: the process instance which provides random numbers,</span>
<span class=sd>            functions for creating, copying, and evaluating solutions, as well</span>
<span class=sd>            as the termination criterion</span>
<span class=sd>        """</span>
        <span class=n>random</span> <span class=o>=</span> <span class=n>process</span><span class=o>.</span><span class=n>get_random</span><span class=p>()</span>   <span class=c1># get the random number generator</span>
        <span class=n>x_cur</span> <span class=o>=</span> <span class=n>process</span><span class=o>.</span><span class=n>create</span><span class=p>()</span>  <span class=c1># create the record for the current solution</span>
        <span class=n>x_new</span> <span class=o>=</span> <span class=n>process</span><span class=o>.</span><span class=n>create</span><span class=p>()</span>  <span class=c1># create the record for the new solution</span>
        <span class=n>n</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>x_cur</span><span class=p>)</span>  <span class=c1># get the scale of problem as length of the solution</span>

        <span class=n>x_cur</span><span class=p>[:]</span> <span class=o>=</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>  <span class=c1># We start by initializing the initial solution</span>
        <span class=n>random</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>x_cur</span><span class=p>)</span>  <span class=c1># as [0...n-1] and then randomly shuffle it.</span>
        <span class=n>f_cur</span> <span class=o>=</span> <span class=n>process</span><span class=o>.</span><span class=n>evaluate</span><span class=p>(</span><span class=n>x_cur</span><span class=p>)</span>  <span class=c1># compute solution quality</span>

        <span class=k>while</span> <span class=ow>not</span> <span class=n>process</span><span class=o>.</span><span class=n>should_terminate</span><span class=p>():</span>  <span class=c1># repeat until we are finished</span>
            <span class=n>process</span><span class=o>.</span><span class=n>copy</span><span class=p>(</span><span class=n>x_new</span><span class=p>,</span> <span class=n>x_cur</span><span class=p>)</span>  <span class=c1># copy current to new solution</span>
            <span class=n>i</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>integers</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>  <span class=c1># choose the first random index</span>
            <span class=n>j</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>integers</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>  <span class=c1># choose the second random index</span>
            <span class=n>x_new</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>x_new</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>x_new</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=n>x_new</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>  <span class=c1># swap values at i and j</span>
            <span class=n>f_new</span> <span class=o>=</span> <span class=n>process</span><span class=o>.</span><span class=n>evaluate</span><span class=p>(</span><span class=n>x_new</span><span class=p>)</span>  <span class=c1># evaluate the new solution</span>
            <span class=k>if</span> <span class=n>f_new</span> <span class=o><</span> <span class=n>f_cur</span><span class=p>:</span>  <span class=c1># if it is better than current solution</span>
                <span class=n>x_new</span><span class=p>,</span> <span class=n>x_cur</span> <span class=o>=</span> <span class=n>x_cur</span><span class=p>,</span> <span class=n>x_new</span>  <span class=c1># swap current and new solution</span>
                <span class=n>f_cur</span> <span class=o>=</span> <span class=n>f_new</span>  <span class=c1># and remember quality of new solution</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__str__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>"""</span>
<span class=sd>        Get the name of this algorithm.</span>

<span class=sd>        This name is then used in the directory path and file name of the</span>
<span class=sd>        log files.</span>

<span class=sd>        :returns: myAlgo</span>
<span class=sd>        """</span>
        <span class=k>return</span> <span class=s2>"myAlgo"</span>


<span class=c1># The four problems we want to try to solve:</span>
<span class=n>problems</span> <span class=o>=</span> <span class=p>[</span><span class=k>lambda</span><span class=p>:</span> <span class=n>MySortProblem</span><span class=p>(</span><span class=mi>5</span><span class=p>),</span>  <span class=c1># sort 5 numbers</span>
            <span class=k>lambda</span><span class=p>:</span> <span class=n>MySortProblem</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span>  <span class=c1># sort 10 numbers</span>
            <span class=k>lambda</span><span class=p>:</span> <span class=n>MySortProblem</span><span class=p>(</span><span class=mi>100</span><span class=p>)]</span>  <span class=c1># sort 100 numbers</span>


<span class=k>def</span><span class=w> </span><span class=nf>make_execution</span><span class=p>(</span><span class=n>problem</span><span class=p>)</span> <span class=o>-></span> <span class=n>Execution</span><span class=p>:</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Create an application of our algorithm to our problem.</span>

<span class=sd>    :param problem: the problem (MySortProblem)</span>
<span class=sd>    :returns: the execution</span>
<span class=sd>    """</span>
    <span class=n>ex</span> <span class=o>=</span> <span class=n>Execution</span><span class=p>()</span>
    <span class=n>ex</span><span class=o>.</span><span class=n>set_solution_space</span><span class=p>(</span>
        <span class=n>Permutations</span><span class=o>.</span><span class=n>standard</span><span class=p>(</span><span class=n>problem</span><span class=o>.</span><span class=n>n</span><span class=p>))</span>  <span class=c1># we use permutations of [0..n-1]</span>
    <span class=n>ex</span><span class=o>.</span><span class=n>set_objective</span><span class=p>(</span><span class=n>problem</span><span class=p>)</span>  <span class=c1># set the objective function</span>
    <span class=n>ex</span><span class=o>.</span><span class=n>set_algorithm</span><span class=p>(</span><span class=n>MyAlgorithm</span><span class=p>())</span>  <span class=c1># apply our algorithm</span>
    <span class=n>ex</span><span class=o>.</span><span class=n>set_max_fes</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span>  <span class=c1># permit 100 FEs</span>
    <span class=k>return</span> <span class=n>ex</span>


<span class=c1># We execute the whole experiment in a temp directory.</span>
<span class=c1># For a real experiment, you would put an existing directory path into `td` by</span>
<span class=c1># doing `from pycommons.io.path import Path; td = Path("mydir")` and not use</span>
<span class=c1># the `with` block.</span>
<span class=k>with</span> <span class=n>temp_dir</span><span class=p>()</span> <span class=k>as</span> <span class=n>td</span><span class=p>:</span>  <span class=c1># create temporary directory `td`</span>
    <span class=n>run_experiment</span><span class=p>(</span><span class=n>base_dir</span><span class=o>=</span><span class=n>td</span><span class=p>,</span>  <span class=c1># set the base directory for log files</span>
                   <span class=n>instances</span><span class=o>=</span><span class=n>problems</span><span class=p>,</span>  <span class=c1># define the problem instances</span>
                   <span class=n>setups</span><span class=o>=</span><span class=p>[</span><span class=n>make_execution</span><span class=p>],</span>  <span class=c1># creator for our algorithm</span>
                   <span class=n>n_runs</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>  <span class=c1># we will execute 5 runs per setup</span>

    <span class=n>from_logs</span><span class=p>(</span>  <span class=c1># parse all log files and print end results</span>
        <span class=n>td</span><span class=p>,</span> <span class=k>lambda</span> <span class=n>er</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>"</span><span class=si>{</span><span class=n>er</span><span class=o>.</span><span class=n>algorithm</span><span class=si>}</span><span class=s2> on </span><span class=si>{</span><span class=n>er</span><span class=o>.</span><span class=n>instance</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>er</span><span class=o>.</span><span class=n>best_f</span><span class=si>}</span><span class=s2>"</span><span class=p>))</span>
<span class=c1># The temp directory is deleted as soon as we leave the `with` block.</span>
</pre></div>
